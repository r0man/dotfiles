;; -*- lisp -*-
(require :stumpwm)
(require :swank)

(in-package :stumpwm)

;; Don't show startup message.
(setf *startup-message* nil)

;; Message bar
(set-fg-color "white")
(set-bg-color "black")
(set-border-color "black")

;; Mode Line
(setf *mode-line-background-color* "black")
(setf *mode-line-foreground-color* "white")
(setf *mode-line-border-color* "black")
(setf *mode-line-timeout* 1)

(setf *screen-mode-line-format*
      (list "[^B%n^b] %W | %g | "
            '(:eval (stumpwm:run-shell-command "date" t))))

;; Use thin window border.
(setf *window-border-style* :thin)

;; Input focus follows the mouse.
(setf *mouse-focus-policy* :sloppy)

(defun start-swank-server ()
  (swank-loader:init)
  (swank:create-server
   :port 4005
   :style swank:*communication-style*
   :dont-close t))

;;; COMMANDS

(defcommand terminal () ()
  "Run or raise the urxvt terminal."
  (run-or-raise "urxvt -e screen" '(:class "URxvt")))

(defcommand terminal-new () ()
  "Run or raise the urxvt terminal."
  (vsplit)
  (fnext)
  (run-shell-command "urxvt"))

(defcommand (fprev tile-group) () ()
  "Cycle through the frame tree to the prev frame."
  (focus-prev-frame (current-group)))

(defcommand file-manager () ()
  "Run or raise the file manager."
  (run-or-raise "nautilus" '(:class "Nautilus")))

(defcommand volume-lower () ()
  "Lower the volume."
  (message "Lower volume"))

(defcommand volume-raise () ()
  "Raise the volume."
  (message "Raise volume"))

(defcommand volume-toggle () ()
  "Toggle the volume."
  (message "Toggle volume"))

(define-key *root-map* (kbd "c") "terminal")

;; Enable the mode line
(mode-line)

;; Change prefix key
(set-prefix-key (kbd "C-z"))

(run-commands
 "gnew Emacs"
 "gnewbg Web")

;; Rule Based Window Placement

(define-frame-preference "Emacs"
    (0 nil t :class "Emacs"))

(define-frame-preference "Web"
    (0 nil t :class "chromium"))

;; Switch to groups with S-[1-9]
(loop for workspace from 1 to 9
   do (define-key *top-map* (kbd (format nil "s-~d" workspace))
        (format nil "gselect ~d" workspace)))

;;; KEY BINDINGS

(define-key *top-map* (kbd "s-RET") "terminal-new")

;; Move focus to the next window.
(define-key *top-map* (kbd "s-j") "fnext")

;; Move focus to the previous window.
(define-key *top-map* (kbd "s-k") "fprev")

;; (refresh-heads)

(run-shell-command "emacs")
(run-shell-command "chromium")

(start-swank-server)
